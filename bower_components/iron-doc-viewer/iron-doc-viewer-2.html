<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../prism-element/prism-highlighter.html">
<link rel="import" href="../prism-element/prism-theme-default.html">

<link rel="import" href="iron-doc-namespace.html">
<link rel="import" href="iron-doc-element.html">
<link rel="import" href="iron-doc-mixin.html">

<!--
Renders documentation describing an element's API.

`iron-doc-viewer` renders element and behavior descriptions as extracted by
[Hydrolysis](https://github.com/PolymerLabs/hydrolysis). You can provide them
either via binding...

    <iron-doc-viewer descriptor="{{elementDescriptor}}"></iron-doc-viewer>

...or by placing the element descriptor in JSON as the text content of an
`iron-doc-viewer`:

    <iron-doc-viewer>
      {
        "is": "awesome-sauce",
        "properties": [
          {"name": "isAwesome", "type": "boolean", "desc": "Is it awesome?"},
        ]
      }
    </iron-doc-viewer>

However, be aware that due to current limitations in Polymer 0.8, _changes_ to
the text content will not be respected, only the initial value will be loaded.
If you wish to update the documented element, please set it via the `descriptor`
property.

@demo demo/index.html Basic Demo
-->

<dom-module id="iron-doc-viewer-2">
  <template>
    <style include="iron-doc-viewer-2-styles prism-theme-default"></style>

    <app-location route="{{route}}"></app-location>

    <template is="dom-if" if="[[_equal(_descriptorType,'namespaces')]]" restamp="true">
      <iron-doc-namespace
          descriptor="[[_currentDescriptor]]"
          root-namespace="[[rootNamespace]]">
      </iron-doc-namespace>
    </template>
    <template is="dom-if" if="[[_equal(_descriptorType,'elements')]]" restamp="true">
      <iron-doc-element descriptor="[[_currentDescriptor]]"></iron-doc-element>
    </template>
    <template is="dom-if" if="[[_equal(_descriptorType,'mixins')]]" restamp="true">
      <iron-doc-mixin descriptor="[[_currentDescriptor]]"></iron-doc-mixin>
    </template>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'iron-doc-viewer-2',

        properties: {
          /**
           * The [Polymer Analyzer](https://github.com/Polymer/polymer-analyzer)-generated
           * element descriptor to display details for.
           *
           * Alternatively, the element descriptor can be provided as JSON via the text content
           * of this element.
           *
           * @type {hydrolysis.ElementDescriptor}
           */
          descriptor: {
            type: Object,
          },

          rootNamespace: {
            type: String,
          },

          _currentDescriptor: {
            type: Object,
          },

          _descriptorType: String,

          /**
           * Prefix for fragment identifiers used in anchors.
           * For static routing `iron-component-page` can
           * set this to a string identifying the current component.
           */
          fragmentPrefix: {
            type: String,
            value: ''
          },
        },

        observers: ['_dataChanged(descriptor,route.path)'],

        ready: function() {
          var jsonDescriptor = this._loadJson();
          // Note that this is only an error during element creation. You are free
          // to stomp over the descriptor after it is ready.
          if (jsonDescriptor && this.descriptor) {
            Polymer.Base._error(
                this,
                'received both a bound descriptor:', this.descriptor,
                'and JSON descriptor:', this._jsonDescriptor,
                'Please provide only one');
            throw new Error(
                '<iron-doc-viewer> accepts either a bound or JSON descriptor; not both');
          }

          if (jsonDescriptor) {
            this.descriptor = jsonDescriptor;
          }
        },

        _equal: function(a, b) {
          return a == b;
        },

        _dataChanged: function(descriptor, routePath) {
          var descriptorType, name;
          if (routePath) {
            var parts = routePath.split('/');
            if (parts.length > 1) {
              [, descriptorType, name] = parts;
            }
          }
          if (!this.descriptor) {
            return;
          }

          if (!descriptorType) {
            // If we don't have a route, display either the top-level namespace
            // or the rootNamespace if set.
            this._descriptorType = 'namespaces';
            if (this.rootNamespace && descriptor.namespaces) {
              var matches = descriptor.namespaces.filter((n) => n.name === this.rootNamespace);
              if (matches && matches.length > 0) {
                this._currentDescriptor = matches[0];
              }
              return;
            }
            this._currentDescriptor = descriptor;
            return;
          }

          var namespace = getNamespace(this.descriptor, name);
          if (namespace == null) {
            // 404?
            return;
          }
          this._descriptorType = descriptorType;
          if (descriptorType === 'namespaces') {
            this._currentDescriptor = namespace.namespaces &&
                namespace.namespaces.filter((n) => n.name === name)[0];
          } else if (descriptorType === 'elements') {
            this._currentDescriptor = namespace.elements &&
                namespace.elements.filter((e) => (e.name || e.tagname) === name)[0];
          } else if (descriptorType === 'mixins') {
            this._currentDescriptor = namespace.mixins &&
                namespace.mixins.filter((m) => m.name === name)[0];
          } else if (descriptorType === 'functions') {
            this._currentDescriptor = namespace.functions &&
                namespace.functions.filter((f) => f.name === name)[0];
          }
        },

        /**
         * Loads a hydrolysis element descriptor (as JSON) from the text content of
         * this element, if present.
         *
         * @return {hydrolysis.ElementDescriptor} The parsed descriptor, or `null`.
         */
        _loadJson: function() {
          var textContent = '';
          Array.prototype.forEach.call(Polymer.dom(this).childNodes, function(node) {
            textContent = textContent + node.textContent;
          });
          textContent = textContent.trim();
          if (textContent === '') return null;

          try {
            return JSON.parse(textContent);
          } catch(error) {
            Polymer.Base._error('Failure when parsing JSON:', textContent, error);
            throw error;
          }
        },
      });

      /**
       * Walks through the tree of namespaces to find the namespace
       * containing `name`
       */
      function getNamespace(descriptor, name) {

        var parts = name.split('.');
        if (parts.length < 2) {
          return undefined;
        }
        parts = parts.slice(0, parts.length - 1);
        var namespace = descriptor;

        for (var part of parts) {
          if (!namespace.namespaces) {
            return undefined;
          }
          var matches = namespace.namespaces.filter((n) => n.name === part);
          if (matches.length === 0) {
            return undefined;
          }
          namespace = matches[0];
        }
        return namespace;
      }
    })();
  </script>
</dom-module>
